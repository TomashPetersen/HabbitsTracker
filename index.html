<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MonthHabit - Трекер привычек</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel Standalone for in-browser JSX/TSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #0f172a; /* bg-slate-900 */
        color: #e2e8f0; /* text-slate-200 */
      }
      .loader {
        text-align: center;
        padding: 4rem;
        font-size: 1.5rem;
        color: #94a3b8; /* text-slate-400 */
      }
    </style>
</head>
<body>
    <div id="root">
        <div class="loader">Загрузка приложения...</div>
    </div>

    <script type="text/babel" data-type="module">
// De-structure React hooks and components for ease of use
const {
    createContext,
    useReducer,
    useEffect,
    useCallback,
    useContext,
    useState,
    useRef,
    useMemo,
    Fragment
} = React;

// --- From constants.ts ---
const MONTH_NAMES = [
  "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
  "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
];
const DAY_NAMES_SHORT = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
const HABIT_COLORS = [
  '#f87171', '#fb923c', '#facc15', '#4ade80',
  '#38bdf8', '#818cf8', '#c084fc', '#f472b6'
];

// --- From utils/calendar.ts ---
const getDaysInMonth = (year, month) => {
  return new Date(year, month + 1, 0).getDate();
};
const getFirstDayOfMonth = (year, month) => {
  const day = new Date(year, month, 1).getDay();
  return day === 0 ? 6 : day - 1;
};

// --- From utils/stats.ts ---
const calculateStreaks = (habit, totalDays, isPastMonth) => {
  let maxStreak = 0;
  let dayStreak = 0;
  const today = new Date();
  const limit = isPastMonth ? totalDays : today.getDate();

  for (let i = 1; i <= totalDays; i++) {
    if (habit.days[i]) {
      dayStreak++;
    } else {
      if (dayStreak > maxStreak) maxStreak = dayStreak;
      dayStreak = 0;
    }
  }
  if (dayStreak > maxStreak) maxStreak = dayStreak;
  
  let currentStreak = 0;
  for (let i = limit; i >= 1; i--) {
      if (habit.days[i]) {
          currentStreak++;
      } else {
          break;
      }
  }
  return { maxStreak, currentStreak };
};
const calculateCompletion = (habit, totalDays) => {
    const completedDays = Object.values(habit.days).filter(Boolean).length;
    if (totalDays === 0) return { percentage: 0, count: 0 };
    const percentage = Math.round((completedDays / totalDays) * 100);
    return { percentage, count: completedDays };
};

// --- From hooks/useDebounce.ts ---
function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);
  return debouncedValue;
}

// --- From services/storageService.ts ---
const STORAGE_KEY = 'monthhabit_v1';
const BACKUP_KEY = 'monthhabit_backup';
const saveState = (state) => {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (error) {
    console.error("Не удалось сохранить состояние:", error);
  }
};
const loadState = () => {
  try {
    const serializedState = localStorage.getItem(STORAGE_KEY);
    return serializedState ? JSON.parse(serializedState) : undefined;
  } catch (error) {
    console.error("Не удалось загрузить состояние:", error);
    return undefined;
  }
};
const exportData = (state) => {
  try {
    const dataStr = JSON.stringify(state, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `monthhabit_backup_${new Date().toISOString().slice(0, 10)}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  } catch (error) {
    console.error("Ошибка экспорта:", error);
  }
};
const importData = (file, callback) => {
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const result = event.target?.result;
      if (typeof result === 'string') {
        const newState = JSON.parse(result);
        if (newState.version && newState.years) {
          const currentState = loadState();
          if (currentState) {
            localStorage.setItem(BACKUP_KEY, JSON.stringify(currentState));
          }
          callback(newState);
          alert("Данные успешно импортированы!");
        } else {
          throw new Error("Неверный формат файла.");
        }
      }
    } catch (error) {
      console.error("Ошибка импорта:", error);
      alert(`Не удалось импортировать данные. Ошибка: ${error.message}`);
    }
  };
  reader.readAsText(file);
};

// --- From context/AppContext.tsx ---
const AppContext = createContext(undefined);
const AppProvider = ({ children }) => {
  const initialState = { version: '1', years: {} };
  
  const appReducer = (state, action) => {
    // Deep copy state to avoid mutation issues
    const newState = JSON.parse(JSON.stringify(state));
    switch (action.type) {
      case 'SET_STATE': return action.payload;
      case 'ADD_HABIT': {
        const { year, month, title } = action.payload;
        const monthKey = `${year}-${month}`;
        if (!newState.years[year]) newState.years[year] = {};
        if (!newState.years[year][monthKey]) newState.years[year][monthKey] = { habits: [] };
        const existingHabits = newState.years[year][monthKey].habits;
        const nextColorIndex = existingHabits.length % HABIT_COLORS.length;
        const newHabit = {
          id: `h-${Date.now()}`, title, days: {}, color: HABIT_COLORS[nextColorIndex],
        };
        newState.years[year][monthKey].habits.push(newHabit);
        return newState;
      }
      case 'UPDATE_HABIT_TITLE': {
        const { year, month, habitId, newTitle } = action.payload;
        const monthKey = `${year}-${month}`;
        const habit = newState.years[year]?.[monthKey]?.habits.find(h => h.id === habitId);
        if (habit) habit.title = newTitle;
        return newState;
      }
      case 'DELETE_HABIT': {
        const { year, month, habitId } = action.payload;
        const monthKey = `${year}-${month}`;
        if (newState.years[year]?.[monthKey]) {
          newState.years[year][monthKey].habits = newState.years[year][monthKey].habits.filter(h => h.id !== habitId);
        }
        return newState;
      }
      case 'TOGGLE_DAY': {
        const { year, month, habitId, day } = action.payload;
        const monthKey = `${year}-${month}`;
        const habit = newState.years[year]?.[monthKey]?.habits.find(h => h.id === habitId);
        if (habit) habit.days[day] = !habit.days[day];
        return newState;
      }
      case 'CLEAR_HISTORY': return initialState;
      default: return state;
    }
  };

  const initialDateState = { year: new Date().getFullYear(), month: new Date().getMonth() };
  const dateReducer = (state, action) => {
    return action.type === 'CHANGE_DATE' ? action.payload : state;
  };

  const [appState, appDispatch] = useReducer(appReducer, loadState() || initialState);
  const [currentDate, dateDispatch] = useReducer(dateReducer, initialDateState);
  const debouncedState = useDebounce(appState, 500);

  useEffect(() => { saveState(debouncedState); }, [debouncedState]);

  const dispatch = useCallback((action) => {
    action.type === 'CHANGE_DATE' ? dateDispatch(action) : appDispatch(action);
  }, []);

  const value = { state: { ...appState, currentDate }, dispatch };
  return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
};

// --- From components/ConfirmationModal.tsx ---
const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm" onClick={e => e.stopPropagation()}>
        <h2 className="text-xl font-bold text-white">{title}</h2>
        <p className="mt-2 text-slate-400">{message}</p>
        <div className="mt-6 flex justify-end gap-4">
          <button onClick={onClose} className="px-4 py-2 rounded-md text-sm font-medium bg-slate-600 hover:bg-slate-500 transition-colors">Отмена</button>
          <button onClick={onConfirm} className="px-4 py-2 rounded-md text-sm font-medium bg-red-600 hover:bg-red-500 text-white transition-colors">Подтвердить</button>
        </div>
      </div>
    </div>
  );
};

// --- From components/Statistics.tsx ---
const Statistics = ({ habit, daysInMonth, isReadOnly }) => {
  const { completion, streaks } = useMemo(() => ({
    completion: calculateCompletion(habit, daysInMonth),
    streaks: calculateStreaks(habit, daysInMonth, isReadOnly),
  }), [habit, daysInMonth, isReadOnly]);
  return (
    <div className="flex flex-col text-center text-sm font-mono text-slate-400">
      <div title="Процент выполнения / выполнено дней">{completion.percentage}% ({completion.count})</div>
      <div className="flex gap-2 justify-center mt-1">
        <div title="Текущий стрик" className="flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-orange-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.934l-6.794 12.42a1 1 0 00.385 1.451l.007.003a1 1 0 001.45-.385c.345-.23.614-.558.822-.934l6.794-12.42a1 1 0 00-.385-1.451z" clipRule="evenodd" /></svg>
          {streaks.currentStreak}
        </div>
        <div title="Максимальный стрик" className="flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clipRule="evenodd" /></svg>
          {streaks.maxStreak}
        </div>
      </div>
    </div>
  );
};

// --- From components/HabitRow.tsx ---
const HabitRow = ({ habit, year, month, daysInMonth, isReadOnly }) => {
  const context = useContext(AppContext);
  const [isEditing, setIsEditing] = useState(false);
  const [title, setTitle] = useState(habit.title);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const debouncedTitle = useDebounce(title, 500);

  useEffect(() => {
    if (debouncedTitle !== habit.title) {
      context?.dispatch({ type: 'UPDATE_HABIT_TITLE', payload: { year, month, habitId: habit.id, newTitle: debouncedTitle } });
    }
  }, [debouncedTitle, habit.title, context, year, month, habit.id]);

  if (!context) return null;
  const { dispatch } = context;

  const handleToggleDay = (day) => {
    if (!isReadOnly) dispatch({ type: 'TOGGLE_DAY', payload: { year, month, habitId: habit.id, day } });
  };
  const handleDelete = () => {
    dispatch({ type: 'DELETE_HABIT', payload: { year, month, habitId: habit.id } });
    setIsDeleteModalOpen(false);
  };
  const handleTitleBlur = () => {
    setIsEditing(false);
    if (title.trim() === '') setTitle(habit.title);
  };
  
  const today = new Date();
  const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

  return (
    <Fragment>
      <div className="sticky left-0 bg-slate-800 z-10 flex items-center gap-2 p-2 border-t border-slate-700">
        <div className="w-2 h-full rounded-full" style={{ backgroundColor: habit.color }}></div>
        {isEditing ? (
          <input
            type="text" value={title} onChange={(e) => setTitle(e.target.value)}
            onBlur={handleTitleBlur} onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
            className="w-full bg-slate-700 text-white p-1 rounded-md" autoFocus
          />
        ) : (
          <span onDoubleClick={() => !isReadOnly && setIsEditing(true)} className="flex-grow cursor-pointer">{habit.title}</span>
        )}
        <button onClick={() => setIsDeleteModalOpen(true)} disabled={isReadOnly} className="ml-auto text-slate-500 hover:text-red-500 disabled:opacity-30 disabled:hover:text-slate-500 p-1">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
        </button>
      </div>
      {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => (
        <div key={day} className={`flex items-center justify-center p-1 border-t border-slate-700 ${isCurrentMonth && day === today.getDate() ? 'bg-slate-700/50' : ''}`}>
          <input type="checkbox" checked={!!habit.days[day]} onChange={() => handleToggleDay(day)} disabled={isReadOnly}
            className={`w-5 h-5 rounded-sm appearance-none border-2 border-slate-600 transition-colors cursor-pointer disabled:cursor-not-allowed disabled:opacity-50 checked:border-transparent`}
            style={habit.days[day] ? { backgroundColor: habit.color } : {}}
          />
        </div>
      ))}
      <div className="flex items-center justify-center p-2 border-t border-slate-700">
        <Statistics habit={habit} daysInMonth={daysInMonth} isReadOnly={isReadOnly} />
      </div>
      <ConfirmationModal
        isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} onConfirm={handleDelete}
        title="Удалить привычку?" message={`Вы уверены, что хотите удалить привычку "${habit.title}"? Это действие необратимо.`}
      />
    </Fragment>
  );
};

// --- From components/MonthView.tsx ---
const MonthView = () => {
  const context = useContext(AppContext);
  if (!context) return null;
  const { state } = context;
  const { year, month } = state.currentDate;
  const monthKey = `${year}-${month}`;
  
  const habits = state.years[year]?.[monthKey]?.habits || [];
  const daysInMonth = getDaysInMonth(year, month);
  const firstDayOfMonth = getFirstDayOfMonth(year, month);
  
  const today = new Date();
  const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
  
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  const selectedDate = new Date(year, month);
  const isReadOnly = selectedDate < now && !(selectedDate.getFullYear() === now.getFullYear() && selectedDate.getMonth() === now.getMonth());

  return (
    <div className="overflow-x-auto">
      {isReadOnly && (
        <div className="text-center p-2 mb-4 bg-yellow-900/50 text-yellow-300 rounded-md border border-yellow-700">
          Это прошлый месяц (только просмотр).
        </div>
      )}
      {habits.length > 0 ? (
        <div className="grid gap-x-1" style={{ gridTemplateColumns: `minmax(150px, 1.5fr) repeat(${daysInMonth}, minmax(36px, 1fr)) minmax(120px, 1fr)`}}>
          <div className="sticky left-0 bg-slate-800 z-10 font-semibold text-slate-400 text-sm text-left p-2">Привычка</div>
          {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => (
            <div key={day} className={`text-center font-mono text-sm p-2 rounded-md ${isCurrentMonth && day === today.getDate() ? 'bg-sky-700 text-white' : 'text-slate-400'}`}>
                <span className="hidden sm:inline">{DAY_NAMES_SHORT[(firstDayOfMonth + day - 1) % 7]}</span>
                <span className="sm:hidden">{day}</span>
                <span className="hidden sm:block">{day}</span>
            </div>
          ))}
          <div className="font-semibold text-slate-400 text-sm text-center p-2">Статистика</div>
          {habits.map(habit => (
            <HabitRow key={habit.id} habit={habit} year={year} month={month}
              daysInMonth={daysInMonth} isReadOnly={isReadOnly} />
          ))}
        </div>
      ) : (
        <div className="text-center py-12 text-slate-500">
          <p>Привычек на этот месяц еще нет.</p>
          <p>Добавьте первую, чтобы начать!</p>
        </div>
      )}
    </div>
  );
};


// --- From components/AddHabitForm.tsx ---
const AddHabitForm = () => {
  const [title, setTitle] = useState('');
  const context = useContext(AppContext);
  if (!context) return null;
  const { state, dispatch } = context;
  const { year, month } = state.currentDate;
  
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  const selectedDate = new Date(year, month);
  const isReadOnly = selectedDate < now && !(selectedDate.getFullYear() === now.getFullYear() && selectedDate.getMonth() === now.getMonth());

  const handleSubmit = (e) => {
    e.preventDefault();
    if (title.trim()) {
      dispatch({ type: 'ADD_HABIT', payload: { year, month, title: title.trim() } });
      setTitle('');
    }
  };

  if (isReadOnly) return null;
  return (
    <form onSubmit={handleSubmit} className="mt-8 flex gap-2">
      <input type="text" value={title} onChange={(e) => setTitle(e.target.value)}
        placeholder="Новая привычка (напр. Читать 15 минут)"
        className="flex-grow bg-slate-700 border border-slate-600 text-slate-200 rounded-md px-4 py-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" />
      <button type="submit" disabled={!title.trim()}
        className="bg-sky-600 hover:bg-sky-500 text-white font-semibold px-4 py-2 rounded-md transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed">
        Добавить
      </button>
    </form>
  );
};

// --- From components/Header.tsx ---
const Header = () => {
  const context = useContext(AppContext);
  const fileInputRef = useRef(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  if (!context) return null;
  const { state, dispatch } = context;
  const { year, month } = state.currentDate;

  const handleDateChange = (monthOffset) => {
    const newDate = new Date(year, month + monthOffset);
    dispatch({ type: 'CHANGE_DATE', payload: { year: newDate.getFullYear(), month: newDate.getMonth() } });
  };
  const handleExport = () => exportData(state);
  const handleImportClick = () => fileInputRef.current?.click();
  const handleFileChange = (event) => {
    const file = event.target.files?.[0];
    if (file && window.confirm("Вы уверены? Текущие данные будут заменены (но сохранятся в резервной копии).")) {
      importData(file, (newState) => dispatch({ type: 'SET_STATE', payload: newState }));
    }
  };
  const handleClearHistory = () => {
    dispatch({ type: 'CLEAR_HISTORY' });
    setIsModalOpen(false);
  };

  return (
    <Fragment>
      <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div className="flex items-center gap-2">
          <button onClick={() => handleDateChange(-1)} className="p-2 rounded-md bg-slate-700 hover:bg-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg></button>
          <span className="text-xl font-semibold w-40 text-center">{MONTH_NAMES[month]} {year}</span>
          <button onClick={() => handleDateChange(1)} className="p-2 rounded-md bg-slate-700 hover:bg-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" /></svg></button>
        </div>
        <div className="flex items-center gap-2">
          <div className="relative group">
            <button className="p-2 rounded-md bg-slate-700 hover:bg-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg></button>
            <div className="absolute right-0 mt-2 w-48 bg-slate-700 rounded-md shadow-lg z-10 hidden group-hover:block">
              <a href="#" onClick={handleExport} className="block px-4 py-2 text-sm text-slate-200 hover:bg-slate-600 rounded-t-md">Экспорт JSON</a>
              <a href="#" onClick={handleImportClick} className="block px-4 py-2 text-sm text-slate-200 hover:bg-slate-600">Импорт JSON</a>
              <a href="#" onClick={() => setIsModalOpen(true)} className="block px-4 py-2 text-sm text-red-400 hover:bg-red-500 hover:text-white rounded-b-md">Очистить историю</a>
              <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
            </div>
          </div>
        </div>
      </div>
      <ConfirmationModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onConfirm={handleClearHistory}
        title="Подтвердите действие" message="Вы уверены, что хотите полностью очистить всю историю? Это действие необратимо."
      />
    </Fragment>
  );
};

// --- From App.tsx ---
const App = () => {
  const context = useContext(AppContext);
  if (!context) return <div className="loader">Инициализация контекста...</div>;
  return (
    <div className="min-h-screen font-sans">
      <main className="container mx-auto p-4 md:p-8">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-8">
            <h1 className="text-4xl md:text-5xl font-bold text-sky-400">MonthHabit</h1>
            <p className="text-slate-400 mt-2">Отслеживайте свои привычки. Месяц за месяцем.</p>
          </div>
          <div className="bg-slate-800 rounded-xl shadow-2xl p-4 sm:p-6">
            <Header />
            <div className="mt-6">
              <MonthView />
              <AddHabitForm />
            </div>
          </div>
        </div>
        <footer className="text-center mt-12 text-slate-500 text-sm">
          <p>Создано с помощью React, Tailwind CSS и Gemini</p>
        </footer>
      </main>
    </div>
  );
};

// --- From index.tsx (entry point) ---
const rootElement = document.getElementById('root');
if (rootElement) {
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <AppProvider>
          <App />
        </AppProvider>
      </React.StrictMode>
    );
} else {
    console.error("Root element not found");
}

    </script>
</body>
</html>
